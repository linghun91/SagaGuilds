# SagaGuild 更新日志

## 2025年7月22日更新

### v1.0.9.37 重要Bug修复版本

#### 修复内容

1. **聊天系统修复**
   - 修复了公会聊天频道显示MemorySection而非实际消息内容的问题
   - 修复了聊天监听器在文本输入后不自动结束监听的问题
   - 修复了会长转让确认后聊天监听器状态未清除的问题

2. **GUI系统修复**
   - 修复了异步线程中打开GUI导致的IllegalStateException错误
   - 修复了成员管理GUI返回按钮无效的问题
   - 修复了GUI切换时鼠标自动移动到屏幕中央的问题

3. **命令系统修复**
   - 修复了/g ally命令参数索引错误导致的功能异常
   - 改进了命令参数处理逻辑，确保索引正确

4. **占位符系统修复**
   - 修复了公会战胜利次数占位符不更新的问题
   - 战争结束后排行榜数据会立即刷新

#### 技术改进

1. **线程安全增强**
   - 所有GUI操作现在都在主线程中执行
   - 使用Bukkit.getScheduler().runTask()确保线程安全

2. **状态管理优化**
   - 使用try-finally机制确保聊天监听器状态正确清除
   - 避免监听器状态残留导致的功能异常

3. **用户体验提升**
   - GUI刷新时不再关闭再打开，避免鼠标位置重置
   - 成员管理界面增加返回按钮，改善导航体验

**版本号：** 1.0.9.37

### v1.0.9.36 重大功能更新

#### 新增功能

1. **图形化领地设置系统**
   - 全新的领地设置GUI界面，提供直观的设置体验
   - 支持保护开关、PVP控制、访客权限管理
   - 实时设置效果预览，操作即时生效
   - 支持访客建筑权限和交互权限独立控制

2. **图形化聊天设置系统**
   - 全新的聊天设置GUI界面，便捷管理聊天功能
   - 支持多种聊天模式切换（公会聊天、联盟聊天）
   - 自定义聊天格式和前缀功能
   - 聊天过滤和自动切换选项

3. **经济系统集成增强**
   - 公会创建费用检查机制（配置项：guild.creation-cost）
   - 领地声明费用检查机制（配置项：land.claim-cost）
   - 自动费用扣除和退还系统
   - 完善的错误处理和用户提示

4. **联盟聊天功能完善**
   - 修复消息广播问题，确保消息正确发送给所有联盟公会成员
   - 改进权限验证机制，加强安全性
   - 统一消息显示格式，提升用户体验
   - 增强错误处理能力

#### 技术改进

1. **GUI系统优化**
   - 修复Material.SIGN兼容性问题，统一使用Material.OAK_SIGN
   - 优化GUI响应速度和事件处理机制
   - 改进材质兼容性，确保跨版本稳定运行

2. **消息系统更新**
   - 添加所有新功能所需的消息配置
   - 支持领地设置相关消息
   - 支持聊天设置相关消息
   - 完善错误提示和用户反馈

#### 使用体验提升

- 更加直观的GUI操作界面
- 更灵活的个性化设置选项
- 更完善的经济系统集成
- 更好的跨公会沟通体验

#### 新手入门建议

1. **创建公会**：先检查是否有足够的资金支付创建费用
2. **设置领地**：使用新的领地设置界面配置保护选项
3. **配置聊天**：在聊天设置中自定义你的公会聊天格式
4. **管理联盟**：利用联盟聊天功能增强跨公会合作

**版本号：** 1.0.9.36

## 2025年7月21日更新

### 占位符更新

**玩家公会信息占位符（支持离线玩家查询）：**
- `%sg_currentguild_name%` - 玩家所在公会名称
- `%sg_currentguild_tag%` - 玩家所在公会标签
- `%sg_currentguild_description%` - 玩家所在公会描述
- `%sg_currentguild_level%` - 玩家所在公会等级
- `%sg_currentguild_role%` - 玩家在公会的职位
- `%sg_currentguild_owner%` - 玩家所在公会会长名称
- `%sg_currentguild_currentmembers%` - 玩家所在公会当前人数
- `%sg_currentguild_maxmembers%` - 玩家所在公会最大人数
- `%sg_currentguild_money%` - 玩家所在公会银行余额
- `%sg_currentguild_warstats%` - 玩家所在公会战争状态
- `%sg_currentguild_allystats%` - 玩家所在公会联盟关系

**排行榜占位符（失败返回空字符串）：**
- `%sg_top1_money_gname%` - 银行资金第1公会名
- `%sg_top1_money_value%` - 银行资金第1公会资金值
- `%sg_top3_members_gname%` - 人数第3公会名
- `%sg_top3_members_value%` - 人数第3公会人数值
- `%sg_top5_level_gname%` - 等级第5公会名称
- `%sg_top5_level_value%` - 等级第5公会等级值


 **兼容性说明**
   - 支持离线玩家查询，无需玩家在线即可获取公会信息
   - 在玩家未加入公会或查询失败时返回空字符串
   - 与各版本PlaceholderAPI兼容，确保稳定运行

**版本号：** 1.0.9.21

## 2025年5月22日更新

### 问题修复

1. **修复了公会加入申请重复消息问题**
   - 修复了玩家申请加入公会时显示两条相同消息的问题
   - 优化了JoinCommand和GuildListListener中的消息发送逻辑
   - 确保消息只在GuildManager.requestJoinGuild方法中发送一次
   - 提高了用户体验，避免重复信息干扰

2. **修复了加入请求ID解析问题**
   - 修复了在处理加入请求时无法正确解析请求ID的问题
   - 改进了JoinRequestListener中的ID提取逻辑，增强兼容性
   - 使用更灵活的方式提取ID，支持不同格式的Lore文本
   - 确保公会管理员可以正确接受或拒绝加入申请

## 2025年5月22日更新

### 新增功能

1. **公会加入申请系统**
   - 实现了玩家申请加入公会功能，替代直接加入
   - 支持玩家同时申请多个公会，首个同意的公会触发加入
   - 当玩家加入某个公会后，自动移除其他所有申请
   - 新增公会加入申请管理GUI，处理收到的加入申请
   - 公会管理员可以接受或拒绝加入申请

### 优化改进

1. **公会管理界面完善**
   - 在公会管理GUI中添加了加入申请管理入口
   - 优化了加入申请的处理流程，提高用户体验
   - 完善了相关消息提示，使流程更加清晰

## 2025年5月21日更新

### 新增功能

1. **公会关系系统增强**
   - 新增公会关系命令系统 `/guild relation` 或 `/g relation`
   - 实现了公会联盟请求和停战请求功能
   - 新增公会关系设置GUI，可视化管理公会关系
   - 新增公会关系管理GUI，处理收到的联盟和停战请求
   - 支持多种关系操作：结盟、宣战、解除联盟、请求停战

2. **公会关系数据模型完善**
   - 新增 `AllianceRequest` 联盟请求模型
   - 新增 `CeasefireRequest` 停战请求模型
   - 完善了联盟和战争状态的数据存储和管理

3. **公会关系命令系统**
   - `/guild relation list` - 显示公会关系列表
   - `/guild relation ally <公会名>` - 申请与指定公会结盟
   - `/guild relation war <公会名>` - 向指定公会宣战
   - `/guild relation break <公会名>` - 解除与指定公会的联盟关系
   - `/guild relation ceasefire <公会名>` - 向战争中的公会请求停战
   - `/guild relation gui [公会名]` - 打开公会关系GUI

### 优化改进

1. **公会信息显示完善**
   - 公会信息中现在会显示完整的联盟关系和战争状态
   - 即使没有关系也会显示"无"而非空白，提高信息完整性
   - 优化了公会关系在GUI中的显示效果

2. **公会战系统增强**
   - 完善了公会战击杀通知系统
   - 实现了公会战积分系统，记录战争贡献
   - 在动作条显示击杀信息，提高战斗体验

### 使用说明

1. **公会加入申请系统**
   - 玩家可以在公会列表中点击公会申请加入
   - 玩家可以同时申请多个公会，等待审核
   - 公会管理员可以在公会管理界面中的"加入申请管理"查看和处理申请
   - 当某个公会接受申请后，玩家会自动加入该公会，其他申请会被取消
   - 公会管理员可以接受或拒绝加入申请

2. **管理公会关系**
   - 公会会长和管理员可以使用 `/guild relation` 命令管理公会关系
   - 可以通过GUI或命令方式发送联盟请求、宣战、解除联盟和请求停战
   - 收到的请求可以在关系管理GUI中处理

3. **查看公会关系**
   - 使用 `/guild relation list` 查看当前公会的联盟和战争状态
   - 在公会信息中也可以查看完整的关系信息

4. **公会战争与停战**
   - 公会之间可以宣战，进入战争状态
   - 战争中的公会可以请求停战，对方接受后结束战争
   - 联盟公会之间不能宣战，需要先解除联盟

## 2025年5月21日更新

### 问题修复

1. **修复了Forge服务端玩家消息兼容性问题**
   - 修复了在Forge服务端上的`NoSuchMethodError: 'void org.bukkit.entity.Player.sendMessage(cn.i7mc.sagaguild.libs.adventure.text.Component)'`错误
   - 添加了PlayerUtil工具类，自动适配不同服务端的API差异
   - 修改了玩家消息发送方法，确保在所有服务端上都能正常显示消息
   - 提高了插件在Forge等服务端上的玩家交互兼容性
   - 优化了MessageUtil类，使用PlayerUtil发送消息

## 2025年5月21日更新

### 问题修复

1. **修复了Forge服务端物品元数据获取兼容性问题**
   - 修复了在Forge服务端上的`NoSuchMethodError: 'cn.i7mc.sagaguild.libs.adventure.text.Component org.bukkit.inventory.meta.ItemMeta.displayName()'`错误
   - 扩展了ItemUtil工具类，添加了获取物品名称和描述的方法
   - 修改了GUI监听器，使用ItemUtil工具类获取物品名称和描述
   - 提高了插件在Forge等服务端上的GUI交互兼容性

## 2025年5月21日更新

### 问题修复

1. **修复了Forge服务端物品元数据设置兼容性问题**
   - 修复了在Forge服务端上的`NoSuchMethodError: 'void org.bukkit.inventory.meta.ItemMeta.displayName(cn.i7mc.sagaguild.libs.adventure.text.Component)'`错误
   - 添加了ItemUtil工具类，自动适配不同服务端的API差异
   - 修改了物品名称和描述设置方法，确保在所有服务端上都能正常显示物品信息
   - 提高了插件在Forge等服务端上的物品显示兼容性

## 2025年5月21日更新

### 问题修复

1. **修复了Forge服务端GUI兼容性问题**
   - 修复了在Forge服务端上的`NoSuchMethodError: 'org.bukkit.inventory.Inventory org.bukkit.Bukkit.createInventory(org.bukkit.inventory.InventoryHolder, int, cn.i7mc.sagaguild.libs.adventure.text.Component)'`错误
   - 添加了InventoryUtil工具类，自动适配不同服务端的API差异
   - 修改了GUI创建方法，确保在所有服务端上都能正常显示GUI
   - 提高了插件在Forge等服务端上的GUI兼容性

## 2025年5月21日更新

### 问题修复

1. **修复了Mohist服务端兼容性问题**
   - 修复了在Mohist服务端上的`com/mohistmc/paper/event/player/AsyncChatEvent不存在`错误
   - 将聊天事件监听器从AsyncChatEvent改为使用更通用的AsyncPlayerChatEvent
   - 提高了插件在Mohist等混合服务端上的兼容性

## 2025年5月21日更新

### 新增功能

1. **服务端兼容性增强**
   - 添加了Adventure API兼容层，支持更多服务端类型
   - 内置并重定位Adventure API库，避免与服务端冲突
   - 新增TeamUtil工具类，自动适配不同服务端的API差异
   - 添加了详细的兼容性文档 (docs/兼容性说明.md)

### 问题修复

1. **修复了Forge服务端兼容性问题**
   - 修复了在Forge服务端上的`NoSuchMethodError: 'void org.bukkit.scoreboard.Team.prefix(net.kyori.adventure.text.Component)'`错误
   - 解决了公会标签显示在某些服务端上不兼容的问题
   - 提高了插件在不同服务端环境下的稳定性

## 2025年5月21日更新

### 新增功能

1. **公会等级成员上限**
   - 新增公会等级对应的最大成员数量配置
   - 1级公会最多10名成员，10级公会最多100名成员
   - 公会列表GUI中现在显示当前成员数/最大成员数
   - 当公会成员已满时，会提示玩家当前等级的最大成员限制

### 优化改进

1. **数据库连接管理优化**
   - 优化了数据库连接管理，保持持久连接而非频繁重连
   - 减少了不必要的数据库连接开销，提高插件性能
   - 减少了控制台日志输出，只在调试模式下显示连接信息

2. **公会列表功能完善**
   - 完善了公会列表GUI功能，支持分页显示
   - 优化了公会信息显示，包括公会名称、标签、描述、会长、成员数量和等级
   - 点击公会后可以查看详细信息并申请加入

3. **公会成员管理优化**
   - 完善了公会成员管理权限系统
   - 根据成员角色限制管理权限，确保安全性
   - 优化了成员管理界面的用户体验

### 问题修复

1. **修复了数据库连接关闭问题**
   - 修复了"database connection closed"错误
   - 解决了频繁显示"数据库重新连接成功"的日志问题
   - 提高了数据库操作的稳定性

2. **修复了公会成员管理相关问题**
   - 修复了无法管理公会成员的问题
   - 修复了权限检查逻辑错误

### 配置说明

在`config.yml`中，您现在可以自定义每个公会等级的最大成员数量：

```
levels:
  max-members-per-level:
    1: 10   # 1级公会最多10名成员
    2: 15   # 2级公会最多15名成员
    3: 20   # 3级公会最多20名成员
    4: 25   # 4级公会最多25名成员
    5: 30   # 5级公会最多30名成员
    6: 40   # 6级公会最多40名成员
    7: 50   # 7级公会最多50名成员
    8: 60   # 8级公会最多60名成员
    9: 80   # 9级公会最多80名成员
    10: 100 # 10级公会最多100名成员
```

您可以根据服务器需求自由调整这些数值。

### 使用说明

1. **查看公会列表**
   - 使用`/guild list`或`/g list`命令打开公会列表GUI
   - 可以使用`/guild list [页码]`查看指定页的公会列表

2. **申请加入公会**
   - 在公会列表中点击想要加入的公会
   - 如果公会是公开的，会显示一个可点击的"[加入公会]"按钮
   - 点击按钮后会自动发送加入请求

3. **管理公会成员**
   - 公会会长和管理员可以使用`/guild members`命令查看成员列表
   - 点击成员可以进行提升、降级、踢出等操作
   - 不同角色有不同的管理权限，详见权限说明

### 未来计划

1. 公会战系统完善
2. 公会任务系统扩展
3. 公会领地功能增强
4. 公会银行系统优化

感谢您使用SagaGuild插件！如有问题或建议，请联系我们的开发团队。
