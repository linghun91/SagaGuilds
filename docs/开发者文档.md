# SagaGuild 开发者文档

## 目录

1. [项目概述](#项目概述)
2. [开发环境设置](#开发环境设置)
3. [项目结构](#项目结构)
4. [核心模块](#核心模块)
5. [数据模型](#数据模型)
6. [数据访问层](#数据访问层)
7. [管理器系统](#管理器系统)
8. [命令系统](#命令系统)
9. [GUI系统](#GUI系统)
10. [事件系统](#事件系统)
11. [API文档](#API文档)
12. [扩展指南](#扩展指南)
13. [贡献指南](#贡献指南)

## 项目概述

SagaGuild 是一个为 Paper 1.20.1 服务器开发的全功能公会插件，提供公会创建、成员管理、领地系统、公会等级、公会战等功能。本文档面向希望理解、修改或扩展插件功能的开发者。

### 技术栈

- **Java版本**: 17
- **构建工具**: Gradle
- **API**: Paper 1.20.1
- **数据存储**: SQLite (使用Paper内置驱动)
- **代码风格**: 遵循Google Java代码规范

## 开发环境设置

### 前提条件

- JDK 17+
- Gradle 7.0+
- Git
- IDE (推荐 IntelliJ IDEA)

### 克隆与构建

1. 克隆仓库：
   ```bash
   git clone https://github.com/linghun91/SagaGuild.git
   cd SagaGuild
   ```

2. 构建项目：
   ```bash
   gradle build
   ```

3. 生成开发服务器：
   ```bash
   gradle runServer
   ```

## 项目结构

SagaGuild 采用模块化设计，主要包含以下包结构：

```
cn.i7mc.sagaguild/
├── SagaGuild.java                     # 主类
├── commands/                          # 命令系统
│   ├── CommandManager.java            # 命令管理器
│   ├── GuildCommand.java              # 主命令处理
│   ├── SubCommand.java                # 子命令接口
│   └── subcommands/                   # 子命令
├── config/                            # 配置系统
│   └── ConfigManager.java             # 配置管理器
├── data/                              # 数据管理
│   ├── DatabaseManager.java           # 数据库管理器
│   ├── dao/                           # 数据访问对象
│   └── models/                        # 数据模型
├── gui/                               # GUI系统
│   ├── GUIManager.java                # GUI管理器
│   ├── holders/                       # 物品栏持有者
│   └── listeners/                     # GUI监听器
├── listeners/                         # 事件监听器
├── managers/                          # 功能管理器
└── utils/                             # 工具类
```

## 核心模块

### 主类 (SagaGuild.java)

主类负责插件的初始化、加载和卸载，管理所有模块的生命周期。

```java
public class SagaGuild extends JavaPlugin {
    // 单例模式
    private static SagaGuild instance;

    // 各管理器实例
    private ConfigManager configManager;
    private DatabaseManager databaseManager;
    private GuildManager guildManager;
    // 其他管理器...

    @Override
    public void onEnable() {
        // 初始化单例
        instance = this;

        // 初始化配置
        configManager = new ConfigManager(this);
        configManager.loadConfigs();

        // 初始化数据库
        databaseManager = new DatabaseManager(this);
        databaseManager.initialize();

        // 初始化管理器
        initializeManagers();

        // 注册命令
        commandManager = new CommandManager(this);
        commandManager.registerCommands();

        // 注册监听器
        registerListeners();

        // 初始化GUI系统
        guiManager = new GUIManager(this);
    }

    // 其他方法...
}
```

### 配置管理器 (ConfigManager.java)

负责加载和管理插件的配置文件。

```java
public class ConfigManager {
    private final SagaGuild plugin;
    private FileConfiguration config;
    private FileConfiguration messages;
    private FileConfiguration debugMessages;

    public ConfigManager(SagaGuild plugin) {
        this.plugin = plugin;
    }

    public void loadConfigs() {
        // 加载配置文件
        loadConfig();
        loadMessages();
        loadDebugMessages();
    }

    // 其他方法...
}
```

## 数据模型

### 公会模型 (Guild.java)

表示一个公会的数据模型。

```java
public class Guild {
    private int id;
    private String name;
    private String tag;
    private String description;
    private String announcement;
    private UUID ownerUuid;
    private int level;
    private int experience;
    private boolean isPublic;
    private Date createdAt;
    private String tagColor;

    // 构造函数、getter和setter...

    /**
     * 增加公会经验
     * @param amount 经验数量
     * @return 是否升级
     */
    public boolean addExperience(int amount) {
        this.experience += amount;
        
        // 检查是否可以升级
        int nextLevelExp = getNextLevelExperience();
        if (this.experience >= nextLevelExp && this.level < 10) {
            this.level++;
            return true;
        }
        
        return false;
    }

    // 其他方法...
}
```

### 成员模型 (GuildMember.java)

表示一个公会成员的数据模型。

```java
public class GuildMember {
    private int id;
    private int guildId;
    private UUID playerUuid;
    private String playerName;
    private Role role;
    private Date joinedAt;

    // 成员角色枚举
    public enum Role {
        OWNER("会长"),
        ADMIN("副会长"),
        ELDER("长老"),
        MEMBER("成员");

        private final String displayName;

        Role(String displayName) {
            this.displayName = displayName;
        }

        public String getDisplayName() {
            return displayName;
        }
    }

    // 构造函数、getter和setter...

    /**
     * 检查是否是会长
     * @return 是否是会长
     */
    public boolean isOwner() {
        return role == Role.OWNER;
    }

    /**
     * 检查是否是管理员或更高职位
     * @return 是否是管理员或更高职位
     */
    public boolean isAdmin() {
        return role == Role.OWNER || role == Role.ADMIN;
    }

    /**
     * 检查是否是长老或更高职位
     * @return 是否是长老或更高职位
     */
    public boolean isElder() {
        return role == Role.OWNER || role == Role.ADMIN || role == Role.ELDER;
    }

    // 其他方法...
}
```

## 数据访问层

### 数据库管理器 (DatabaseManager.java)

负责数据库连接和表结构管理。

```java
public class DatabaseManager {
    private final SagaGuild plugin;
    private Connection connection;

    public DatabaseManager(SagaGuild plugin) {
        this.plugin = plugin;
    }

    public void initialize() {
        // 创建数据库连接
        // 创建表结构
        createTables();
    }

    private void createTables() {
        // 创建公会表
        // 创建成员表
        // 创建领地表
        // 创建其他必要的表
    }

    // 其他方法...
}
```

### 数据访问对象 (DAO)

提供数据库操作的抽象层，处理CRUD操作。

```java
public class GuildDAO {
    private final DatabaseManager databaseManager;

    public GuildDAO(DatabaseManager databaseManager) {
        this.databaseManager = databaseManager;
    }

    public int createGuild(Guild guild) {
        // 插入公会记录
        return -1;
    }

    public Guild getGuildById(int id) {
        // 根据ID查询公会
        return null;
    }

    // 其他方法...
}
```

## 管理器系统

### 公会管理器 (GuildManager.java)

负责公会的创建、解散和管理。

```java
public class GuildManager {
    private final SagaGuild plugin;
    private final GuildDAO guildDAO;
    private final MemberDAO memberDAO;

    // 缓存公会数据
    private final Map<Integer, Guild> guildsById;
    private final Map<String, Guild> guildsByName;
    private final Map<String, Guild> guildsByTag;
    private final Map<UUID, Integer> playerGuildMap;

    public GuildManager(SagaGuild plugin) {
        this.plugin = plugin;
        this.guildDAO = new GuildDAO(plugin);
        this.memberDAO = new MemberDAO(plugin);

        this.guildsById = new HashMap<>();
        this.guildsByName = new HashMap<>();
        this.guildsByTag = new HashMap<>();
        this.playerGuildMap = new HashMap<>();

        // 加载所有公会数据到缓存
        loadGuilds();
    }

    // 其他方法...
}
```

## GUI系统

### GUI管理器 (GUIManager.java)

负责创建和管理GUI界面。

```java
public class GUIManager {
    private final SagaGuild plugin;

    public GUIManager(SagaGuild plugin) {
        this.plugin = plugin;

        // 注册GUI监听器
        plugin.getServer().getPluginManager().registerEvents(new GuildListListener(plugin), plugin);
        plugin.getServer().getPluginManager().registerEvents(new GuildManageListener(plugin), plugin);
        plugin.getServer().getPluginManager().registerEvents(new GuildMemberListener(plugin), plugin);
        plugin.getServer().getPluginManager().registerEvents(new GuildSettingsListener(plugin), plugin);
    }

    /**
     * 打开公会列表GUI
     * @param player 玩家
     * @param page 页码
     */
    public void openGuildListGUI(Player player, int page) {
        // 创建并打开公会列表GUI
    }

    /**
     * 打开公会管理GUI
     * @param player 玩家
     * @param guild 公会对象
     */
    public void openGuildManageGUI(Player player, Guild guild) {
        // 创建并打开公会管理GUI
    }

    // 其他方法...
}
```

### 物品栏持有者 (InventoryHolder)

实现InventoryHolder接口，用于标识不同类型的GUI。

```java
public class GuildListHolder implements InventoryHolder {
    private final int page;

    public GuildListHolder(int page) {
        this.page = page;
    }

    public int getPage() {
        return page;
    }

    @Override
    public Inventory getInventory() {
        return null; // 由Bukkit管理
    }
}
```

## API文档

SagaGuild 提供了API，允许其他插件与公会系统集成。

### API接口

```java
public interface SagaGuildAPI {
    /**
     * 获取玩家所在的公会
     * @param playerUuid 玩家UUID
     * @return 公会对象，不存在返回null
     */
    Guild getPlayerGuild(UUID playerUuid);

    /**
     * 获取指定名称的公会
     * @param name 公会名称
     * @return 公会对象，不存在返回null
     */
    Guild getGuildByName(String name);

    /**
     * 获取所有公会
     * @return 公会列表
     */
    List<Guild> getAllGuilds();

    // 其他方法...
}
```

### API实现

```java
public class SagaGuildAPIImpl implements SagaGuildAPI {
    private final SagaGuild plugin;

    public SagaGuildAPIImpl(SagaGuild plugin) {
        this.plugin = plugin;
    }

    @Override
    public Guild getPlayerGuild(UUID playerUuid) {
        return plugin.getGuildManager().getPlayerGuild(playerUuid);
    }

    // 其他方法实现...
}
```

## 扩展指南

### 添加新的子命令

1. 创建一个实现 `SubCommand` 接口的新类：

```java
public class NewCommand implements SubCommand {
    private final SagaGuild plugin;

    public NewCommand(SagaGuild plugin) {
        this.plugin = plugin;
    }

    @Override
    public String getName() {
        return "newcommand";
    }

    @Override
    public String getDescription() {
        return "新命令的描述";
    }

    @Override
    public String getSyntax() {
        return "/guild newcommand [参数]";
    }

    @Override
    public String[] getAliases() {
        return new String[]{"nc"};
    }

    @Override
    public boolean execute(Player player, String[] args) {
        // 命令执行逻辑
        return true;
    }

    @Override
    public List<String> tabComplete(Player player, String[] args) {
        // Tab补全逻辑
        return new ArrayList<>();
    }
}
```

2. 在 `CommandManager` 中注册新命令：

```java
private void registerSubCommands() {
    // 注册其他命令...
    registerSubCommand(new NewCommand(plugin));
}
```

### 添加新的GUI

1. 创建一个实现 `InventoryHolder` 接口的新类：

```java
public class NewGUIHolder implements InventoryHolder {
    private final int param;

    public NewGUIHolder(int param) {
        this.param = param;
    }

    public int getParam() {
        return param;
    }

    @Override
    public Inventory getInventory() {
        return null; // 由Bukkit管理
    }
}
```

2. 创建一个实现 `Listener` 接口的新类处理GUI事件：

```java
public class NewGUIListener implements Listener {
    private final SagaGuild plugin;

    public NewGUIListener(SagaGuild plugin) {
        this.plugin = plugin;
    }

    @EventHandler
    public void onInventoryClick(InventoryClickEvent event) {
        // 检查是否是新GUI
        if (!(event.getInventory().getHolder() instanceof NewGUIHolder)) {
            return;
        }

        // 取消事件
        event.setCancelled(true);

        // 处理点击事件
        // ...
    }
}
```

3. 在 `GUIManager` 中添加打开新GUI的方法：

```java
public void openNewGUI(Player player, int param) {
    // 创建物品栏
    Inventory inventory = Bukkit.createInventory(new NewGUIHolder(param), 54, Component.text("新GUI"));

    // 填充物品
    // ...

    // 打开GUI
    player.openInventory(inventory);
}
```

4. 在 `GUIManager` 构造函数中注册新的监听器：

```java
public GUIManager(SagaGuild plugin) {
    this.plugin = plugin;

    // 注册其他监听器...
    plugin.getServer().getPluginManager().registerEvents(new NewGUIListener(plugin), plugin);
}
```
